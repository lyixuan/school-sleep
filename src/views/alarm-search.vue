<template>
  <div class="alarm-search">
    <s-navi :nData="navi_text"></s-navi>
    <div style="width: 100%;height: 100%;">
      <div class="condition">
        <div class="bg-blue">检索条件</div>

        <div class="condition0">
          <div class="fl" style="margin-top: 5px;">时间范围：</div>
          <el-date-picker
            class="date_p fl" v-model="date_begin" size="small"
            type="datetime" :editable="false" :clearable="false"
            placeholder="选择开始时间">
          </el-date-picker>
          <el-date-picker
            class="date_p fl" v-model="date_end" size="small"
            type="datetime" :editable="false" :clearable="false"
            placeholder="选择结束时间">
          </el-date-picker>
        </div>

        <div class="condition1">
          <div class="fl">报警类型：</div>
          <el-checkbox class="fl" v-model="checkAll" @change="handleCheckAllChange">全选
          </el-checkbox>
          <el-checkbox-group class="fl" v-model="checked" @change="handleChecked">
            <el-checkbox v-for="type in types" :label="type.id" :key="type.id">{{type.des}}</el-checkbox>
          </el-checkbox-group>
        </div>

        <div class="condition2">
          <div class="fl">检索方式：</div>
          <el-radio-group v-model="radio">
            <el-radio :label="0">全部</el-radio>
            <el-radio :label="1">个人检索</el-radio>
            <el-radio :label="2">床位检索</el-radio>
            <el-radio :label="3">分级检索</el-radio>
          </el-radio-group>
        </div>

        <div class="bg-blue">检索内容</div>

        <div class="condition3">
          <div class="fl c3f" v-show="0==radio">时间范围：</div>
          <div class="fl c3f" v-show="1==radio">个人检索：</div>
          <div class="fl c3f" v-show="2==radio">床位检索：</div>
          <div class="fl c3f" v-show="3==radio">分级检索：</div>
          <div class="c3-1" v-show="1==radio">
            <el-input class="m-input" size="small" placeholder="请输入学号或姓名" v-model="cust_info"></el-input>
          </div>

          <div class="c3-2" v-show="2==radio">
            <el-autocomplete class="m-input" size="small" v-model="bed_id" :fetch-suggestions="querySearchAsync"
                             placeholder="请输入床位号"
                             @select="handleSelect"></el-autocomplete>
          </div>

          <div class="c3-3" v-show="3==radio">
            <el-cascader :options="levels" change-on-select class="m-cas" size="small"
                         @change="handleChange"></el-cascader>
          </div>

          <el-button type="primary" class="m-btn" @click="search">开始检索</el-button>
        </div>
      </div>
      <div style="clear: both"></div>
      <div class="table">
        <div class="t-h">检索详情 <span class="export" @click="exportExcel">导出Excel</span></div>
        <div class="t-b">
          <div class="t-bd" v-loading.body="tb_loading">
            <el-table :data="alarmArr" style="width: 100%" border
                      :default-sort="{prop: 'alarm_time', order: 'descending'}" max-height="500">
              <el-table-column fixed prop="student_id" label="学号" min-width="100" show-overflow-tooltip
                               sortable></el-table-column>
              <el-table-column fixed prop="student_name" label="姓名" min-width="100" show-overflow-tooltip
                               sortable></el-table-column>
              <el-table-column prop="sche_begin_time" label="计划入寓时间" min-width="180" show-overflow-tooltip
                               sortable></el-table-column>
              <el-table-column prop="sche_end_time" label="计划出寓时间" min-width="180" show-overflow-tooltip
                               sortable></el-table-column>
              <el-table-column prop="section_des" label="阶段" min-width="100" show-overflow-tooltip
                               sortable></el-table-column>
              <el-table-column prop="grade_des" label="年级" min-width="100" show-overflow-tooltip
                               sortable></el-table-column>
              <el-table-column prop="class_des" label="班级" min-width="100" show-overflow-tooltip
                               sortable></el-table-column>
              <el-table-column prop="apart_des" label="公寓" min-width="100" show-overflow-tooltip
                               sortable></el-table-column>
              <el-table-column prop="room_des" label="房间" min-width="100" show-overflow-tooltip
                               sortable></el-table-column>
              <el-table-column prop="bed_des" label="床位" min-width="100" show-overflow-tooltip
                               sortable></el-table-column>
              <el-table-column fixed="right"  prop="alarm_state_des" label="报警类型" min-width="150" show-overflow-tooltip
                               sortable></el-table-column>
              <el-table-column fixed="right"  prop="alarm_time" label="报警时间" min-width="180" show-overflow-tooltip
                               sortable></el-table-column>
            </el-table>

            <el-pagination class="m-paging"
                           @size-change="handleSizeChange"
                           @current-change="handleCurrentChange"
                           :current-page="currentPage"
                           :page-sizes="[10, 20, 30]"
                           :page-size="pageSize"
                           layout="total, sizes, prev, pager, next"
                           :total="totalNum">
            </el-pagination>
          </div>
        </div>
      </div>
      <div>
      </div>
    </div>
  </div>
</template>

<script>
  import SNavi from '../components/Navi.vue'
  export default {
    name: 'search-index',
    components: {
      SNavi
    },
    data () {
      return {
        navi_text: {
          title: '报警检索',
          subTitle: '',
          btn: ''
        },
        // 多选
        checkAll: true,
        checked: [1, 2, 3, 4, 5, 6],
        types: [
          {id: 1, des: '设备故障'},
          {id: 2, des: '睡眠时间不足60%'},
          {id: 3, des: '在床未睡1小时'},
          {id: 4, des: '离床3次'},
          {id: 5, des: '离床30分钟'},
          {id: 6, des: '频繁体动'}],
        // 单选
        radio: 0,
        // 个人
        cust_info: '',
        // 床位
        bed_id: '',
        date_begin:'',
        date_end:'',
        // 分级
        levels: [],
        checkedLevels: [],

        timer: null,
        alarmArr: [],

        currentPage: 1,
        pageSize: 10,
        totalNum: 0,
        tb_loading:false
      }
    },
    mounted () {
      let a = new Date().getTime() - 24 * 1000 * 60 * 60
      this.date_begin = (new Date(a)).Format('yyyy-MM-dd hh:mm:ss')
      this.date_end = (new Date()).Format('yyyy-MM-dd hh:mm:ss')
      this.search();
      this.getLevels()
    },

    methods: {
      exportExcel(){
        let start = this.date_begin!= null ? new Date(this.date_begin).Format('yyyy-MM-dd hh:mm:ss') : null
        let end = this.date_end != null ? new Date(this.date_end).Format('yyyy-MM-dd hh:mm:ss') : null
        let params = {
          sleep_type: this.checked,
          search_type: this.radio,
          start_time: start,
          end_time: end
        };
        if (this.radio == 1) {
          params.search_content = {cust_info: this.cust_info}
        }
        if (this.radio == 2) {
          params.search_content = {bed_id: this.bed_id}
        }
        if (this.radio == 3) {
          params.search_content = {level: this.checkedLevels}
        }

        window.open(P_MONITOR + 'alarm_search_excel.php' + this.serialize(params));
      },
      serialize(params) {
        let result = '?'
        for (let key in params) {
          if (key == 'search_content') {
            for (let c in params[key]) {
              result += c + '=' + params[key][c] + '&'
            }
          } else {
            result += key + '=' + params[key] + '&'
          }
        }
        return result.substr(0, result.length - 1)
      },
      search(type){
        let start = this.date_begin!= null ? new Date(this.date_begin).Format('yyyy-MM-dd hh:mm:ss') : null
        let end = this.date_end != null ? new Date(this.date_end).Format('yyyy-MM-dd hh:mm:ss') : null
        let params = {
          alarm_type: this.checked,
          search_type: this.radio,
          start_time: start,
          end_time: end
        };
        if (this.radio == 1) {
          params.search_content = {cust_info: this.cust_info}
        }
        if (this.radio == 2) {
          params.search_content = {bed_id: this.bed_id}
        }
        if (this.radio == 3) {
          params.search_content = {level: this.checkedLevels}
        }
        if (type == 1) {
          // 点击分页
          params.page_size = this.pageSize
          params.current_page = this.currentPage
        } else {
          // 点击查询
          this.pageSize = 10
          this.currentPage = 1
          params.page_size = this.pageSize
          params.current_page = this.currentPage

        }

        this.requestData(params)
      },
      requestData(params){
        this.tb_loading = true
        this.$resource(P_MONITOR + 'alarm_search').save({}, params).then((response) => {
          this.tb_loading = false
          if(response.body.code == 200){
            let r_data = response.body.data;
            // 处理数据
            this.alarmArr = r_data.alarm_data

            this.paging(r_data.paging)

          } else {
            this.alertMsg("error", response.body.msg?response.body.msg:'服务器端错误' )
          }
        }, (response) => {
        })
      },
      getLevels(){
        this.$resource(P_BASE + 'level_list').get().then((response) => {
          this.levels = response.body.data;
        })
      },
      handleCheckAllChange(event) {
        this.checked = event.target.checked ? [1, 2, 3, 4, 5, 6] : [];
      },
      handleChecked(value) {
        let checkedCount = value.length;
        this.checkAll = checkedCount === this.types.length;
      },
      querySearchAsync(queryString, cb) {
        clearTimeout(this.timer)
        this.timer = setTimeout(query, 1000);
        let that = this

        function query() {
          let results = [];
          that.$resource(P_BASE + 'bed_no_list').get({bed_id_like: queryString}).then((response) => {
            results = response.body.data;
            cb(results);
          })
        }
      },
      handleSelect(item) {
        this.bed_id = item.value
      },
      handleChange(value){
        this.checkedLevels = value
      },

      handleSizeChange(val) {
        this.pageSize = val
        this.search(1)
      },
      handleCurrentChange(val) {
        this.currentPage = val;
        this.search(1)
      },
      paging(p){
        this.totalNum = p.total_num;
      }
    }
  }
</script>

<style scoped>
  @import "../assets/css/chart-table-page-com.css";

  .condition {
    margin-top: 5px;
    background: #fff;
    padding: 5px;
  }

  .bg-blue {
    background: #E7F4FA;
    color: #2195CB;
    height: 25px;
    line-height: 25px;
    padding-left: 5px;
    width: 100%;
    box-sizing: border-box;
  }

  .condition0,.condition1, .condition2, .condition3 {
    width: 100%;
    height: 30px;
    padding: 10px;
  }

  .condition3 {
    height: auto;
    overflow: hidden;
  }

  .fl {
    float: left;
  }

  .fl:nth-child(1), .fl:nth-child(2) {
    margin-right: 10px;
  }

  .t-bd {
    padding: 10px;
  }

  .m-btn {
    width: 120px;
    border-radius: 0;
    margin-left: 20px;
    height: 30px;
    line-height: 5px;
    float: left;
  }

  .m-input {
    float: left;
    width: 200px;
  }

  .c3f, .m-input {
    height: 30px;
    line-height: 30px;
  }

  .date_p {
    margin-left: 10px;
    float: left;
  }

  .m-cas {
    float: left;
    width: 300px;

  }
</style>
